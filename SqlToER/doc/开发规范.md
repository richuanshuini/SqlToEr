# SqlToER 开发规范

本文档规定了 SqlToER 项目的代码组织结构、命名规范和 MVVM 开发模式。

---

## 1. 目录结构

```
SqlToER/
├── App.xaml                  # 应用程序入口（配置 Prism）
├── App.xaml.cs
│
├── Model/                    # 数据模型层
├── View/                     # 视图层
├── ViewModel/                # 视图模型层
├── Service/                  # 服务层
├── Helper/                   # 辅助工具类
│
└── doc/                      # 项目文档
```

---

## 2. 目录职责说明

### 2.1 Model 层

存放所有数据相关的类：

| 类型 | 说明 | 文件命名示例 |
|------|------|-------------|
| 实体类 | 数据库表映射、业务数据结构 | `TableInfo.cs`, `ColumnInfo.cs` |
| DTO | 数据传输对象 | `ConnectionConfigDto.cs` |
| 枚举 | 枚举定义 | `DatabaseType.cs`, `RelationType.cs` |

**规范：**
- 实体类应为 POCO，不包含业务逻辑
- 属性使用自动属性 `{ get; set; }`
- 需要属性通知的实体可继承 `BindableBase`

### 2.2 View 层

存放所有视图相关文件：

| 类型 | 说明 | 文件命名示例 |
|------|------|-------------|
| 窗口 | 独立窗口 | `MainWindow.xaml`, `SettingsWindow.xaml` |
| 用户控件 | 可复用控件 | `TableCardControl.xaml` |
| 对话框 | 弹出对话框 | `AboutDialog.xaml` |
| 资源字典 | 样式、模板 | `Styles.xaml`, `Templates.xaml` |
| 转换器 | 值转换器 | `BoolToVisibilityConverter.cs` |

**规范：**
- View 只负责 UI 展示，禁止包含业务逻辑
- XAML 与 code-behind 文件成对出现
- 资源字典按功能命名，在 App.xaml 中统一引用

### 2.3 ViewModel 层

存放所有视图模型：

| 类型 | 说明 | 文件命名示例 |
|------|------|-------------|
| ViewModel | 视图对应的逻辑 | `MainWindowViewModel.cs` |
| 基类 | ViewModel 基类 | `ViewModelBase.cs` |

**规范：**
- 所有 ViewModel 必须继承 `BindableBase`
- 命名规则：`[View名]ViewModel`
- 命令使用 `DelegateCommand` 或 `DelegateCommand<T>`

### 2.4 Service 层

存放业务服务：

| 类型 | 说明 | 文件命名示例 |
|------|------|-------------|
| 服务接口 | 服务定义 | `IDatabaseService.cs` |
| 服务实现 | 服务具体实现 | `DatabaseService.cs` |

**规范：**
- 服务必须先定义接口
- 接口以 `I` 开头，如 `IDatabaseService`
- 实现类去掉 `I`，如 `DatabaseService`

### 2.5 Helper 层

存放辅助工具：

| 类型 | 说明 | 文件命名示例 |
|------|------|-------------|
| 扩展方法 | 类型扩展 | `StringExtensions.cs`, `CollectionExtensions.cs` |
| 工具类 | 静态工具 | `SqlParser.cs`, `FileHelper.cs` |

**规范：**
- 扩展方法类必须为 `static class`
- 工具类保持单一职责

---

## 3. 命名规范

### 3.1 代码命名

| 类型 | 规则 | 示例 |
|------|------|------|
| 类 | PascalCase | `TableInfo`, `DatabaseService` |
| 接口 | I + PascalCase | `IDatabaseService` |
| 方法 | PascalCase | `GetTableList()` |
| 属性 | PascalCase | `ConnectionString` |
| 私有字段 | _ + camelCase | `_connectionString` |
| 常量 | PascalCase | `MaxRetryCount` |
| 参数 | camelCase | `tableName` |

### 3.2 文件命名

| 类型 | 规则 | 示例 |
|------|------|------|
| View | 功能名 + 类型后缀 | `MainWindow.xaml`, `TableCardControl.xaml` |
| ViewModel | View名 + ViewModel | `MainWindowViewModel.cs` |
| Service | I + 功能名 + Service | `IDatabaseService.cs` |
| Model | 实体名（无后缀） | `TableInfo.cs` |
| Converter | 功能 + Converter | `BoolToVisibilityConverter.cs` |
| Extensions | 类型 + Extensions | `StringExtensions.cs` |

### 3.3 XAML 元素命名

```xml
<!-- 使用 camelCase -->
<Button x:Name="connectButton" />
<TextBox x:Name="connectionStringTextBox" />
<DataGrid x:Name="tableDataGrid" />
```

---

## 4. MVVM 模式规范

### 4.1 架构原则

```
┌─────────────┐    绑定    ┌─────────────┐
│    View     │ ◄────────► │  ViewModel  │
│  (XAML)     │   命令    │   (C#)      │
└─────────────┘           └──────┬──────┘
                                 │ 调用
                                 ▼
                          ┌─────────────┐
                          │   Service   │
                          └──────┬──────┘
                                 │ 使用
                                 ▼
                          ┌─────────────┐
                          │    Model    │
                          └─────────────┘
```

**核心原则：**
- View 不引用 ViewModel 具体类型
- ViewModel 不引用 View
- Model 不引用 ViewModel

### 4.2 ViewModel 模板

```csharp
using Prism.Commands;
using Prism.Mvvm;
using SqlToER.Service;

namespace SqlToER.ViewModel
{
    public class MainWindowViewModel : BindableBase
    {
        // 1. 私有字段
        private string _connectionString = string.Empty;
        private readonly IDatabaseService _databaseService;

        // 2. 公共属性
        public string ConnectionString
        {
            get => _connectionString;
            set => SetProperty(ref _connectionString, value);
        }

        // 3. 命令
        public DelegateCommand ConnectCommand { get; }

        // 4. 构造函数（依赖注入）
        public MainWindowViewModel(IDatabaseService databaseService)
        {
            _databaseService = databaseService;
            ConnectCommand = new DelegateCommand(ExecuteConnect, CanConnect);
        }

        // 5. 命令实现
        private void ExecuteConnect()
        {
            _databaseService.Connect(ConnectionString);
        }

        private bool CanConnect()
        {
            return !string.IsNullOrWhiteSpace(ConnectionString);
        }
    }
}
```

### 4.3 属性绑定

```csharp
// ViewModel
private string _tableName;
public string TableName
{
    get => _tableName;
    set => SetProperty(ref _tableName, value);
}
```

```xml
<!-- View -->
<TextBox Text="{Binding TableName, UpdateSourceTrigger=PropertyChanged}" />
```

### 4.4 命令绑定

```csharp
// ViewModel
public DelegateCommand SaveCommand { get; }
public DelegateCommand<string> SearchCommand { get; }

// 构造函数中初始化
SaveCommand = new DelegateCommand(ExecuteSave);
SearchCommand = new DelegateCommand<string>(ExecuteSearch);
```

```xml
<!-- View -->
<Button Command="{Binding SaveCommand}" Content="保存" />
<TextBox>
    <TextBox.InputBindings>
        <KeyBinding Key="Enter" Command="{Binding SearchCommand}"
                    CommandParameter="{Binding Text, RelativeSource={RelativeSource AncestorType=TextBox}}" />
    </TextBox.InputBindings>
</TextBox>
```

### 4.5 集合绑定

```csharp
// ViewModel
using System.Collections.ObjectModel;

public ObservableCollection<TableInfo> Tables { get; } = new();
```

```xml
<!-- View -->
<DataGrid ItemsSource="{Binding Tables}" AutoGenerateColumns="False">
    <DataGrid.Columns>
        <DataGridTextColumn Binding="{Binding Name}" Header="表名" />
        <DataGridTextColumn Binding="{Binding Schema}" Header="架构" />
    </DataGrid.Columns>
</DataGrid>
```

---

## 5. Prism 框架规范

### 5.1 应用程序配置

```csharp
// App.xaml
<prism:PrismApplication x:Class="SqlToER.App"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:prism="http://prismlibrary.com/">
</prism:PrismApplication>
```

```csharp
// App.xaml.cs
using Prism.DryIoc;
using Prism.Ioc;
using SqlToER.Service;
using SqlToER.View;
using SqlToER.ViewModel;

namespace SqlToER
{
    public partial class App : PrismApplication
    {
        protected override Window CreateShell()
        {
            return Container.Resolve<MainWindow>();
        }

        protected override void RegisterTypes(IContainerRegistry containerRegistry)
        {
            // 注册服务
            containerRegistry.RegisterSingleton<IDatabaseService, DatabaseService>();

            // 注册 ViewModel（可选，Prism 会自动定位）
            containerRegistry.Register<MainWindowViewModel>();
        }
    }
}
```

### 5.2 ViewModel 与 View 关联

**方式一：约定（推荐）**

View 命名为 `MainWindow`，ViewModel 命名为 `MainWindowViewModel`，Prism 自动关联。

**方式二：显式注册**

```csharp
ViewModelLocationProvider.Register<MainWindow, MainWindowViewModel>();
```

### 5.3 事件聚合

```csharp
// 定义事件（可放在 Model 或单独文件）
using Prism.Events;

public class TableSelectedEvent : PubSubEvent<TableInfo> { }

// 发布事件
_eventAggregator.GetEvent<TableSelectedEvent>().Publish(tableInfo);

// 订阅事件
_eventAggregator.GetEvent<TableSelectedEvent>().Subscribe(OnTableSelected);
```

---

## 6. 代码规范

### 6.1 using 语句顺序

```csharp
// 1. System
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;

// 2. 第三方库
using Prism.Commands;
using Prism.Mvvm;

// 3. 项目内部
using SqlToER.Model;
using SqlToER.Service;
```

### 6.2 成员排列

```csharp
public class ExampleViewModel : BindableBase
{
    // 1. 常量
    private const int MaxRetry = 3;

    // 2. 私有字段
    private readonly IService _service;
    private string _name = string.Empty;

    // 3. 公共属性
    public string Name
    {
        get => _name;
        set => SetProperty(ref _name, value);
    }

    // 4. 命令
    public DelegateCommand SaveCommand { get; }

    // 5. 构造函数
    public ExampleViewModel(IService service)
    {
        _service = service;
        SaveCommand = new DelegateCommand(ExecuteSave);
    }

    // 6. 公共方法
    public void Initialize() { }

    // 7. 私有方法
    private void ExecuteSave() { }
}
```

### 6.3 可空引用类型

项目已启用 `Nullable`，正确标注可空类型：

```csharp
public string? OptionalValue { get; set; }
public string RequiredValue { get; set; } = string.Empty;

public void Process(string? input)
{
    if (input is null) return;
    // 使用 input
}
```

### 6.4 注释

```csharp
/// <summary>
/// 数据库连接服务接口
/// </summary>
public interface IDatabaseService
{
    /// <summary>
    /// 测试数据库连接
    /// </summary>
    /// <param name="connectionString">连接字符串</param>
    /// <returns>连接是否成功</returns>
    Task<bool> TestConnectionAsync(string connectionString);
}
```

---

## 7. 示例文件

### 7.1 Model 示例

```csharp
// Model/TableInfo.cs
namespace SqlToER.Model
{
    public class TableInfo
    {
        public string Name { get; set; } = string.Empty;
        public string? Schema { get; set; }
        public List<ColumnInfo> Columns { get; set; } = new();
    }
}

// Model/ColumnInfo.cs
namespace SqlToER.Model
{
    public class ColumnInfo
    {
        public string Name { get; set; } = string.Empty;
        public string DataType { get; set; } = string.Empty;
        public bool IsPrimaryKey { get; set; }
        public bool IsForeignKey { get; set; }
        public bool IsNullable { get; set; }
    }
}

// Model/DatabaseType.cs
namespace SqlToER.Model
{
    public enum DatabaseType
    {
        SqlServer,
        MySQL,
        PostgreSQL,
        SQLite
    }
}
```

### 7.2 Service 示例

```csharp
// Service/IDatabaseService.cs
using SqlToER.Model;

namespace SqlToER.Service
{
    public interface IDatabaseService
    {
        Task<bool> TestConnectionAsync(string connectionString);
        Task<List<TableInfo>> GetTablesAsync();
        Task<List<ColumnInfo>> GetColumnsAsync(string tableName);
    }
}

// Service/DatabaseService.cs
using SqlToER.Model;

namespace SqlToER.Service
{
    public class DatabaseService : IDatabaseService
    {
        public async Task<bool> TestConnectionAsync(string connectionString)
        {
            // 实现连接测试
            return await Task.FromResult(true);
        }

        public async Task<List<TableInfo>> GetTablesAsync()
        {
            // 实现获取表列表
            return await Task.FromResult(new List<TableInfo>());
        }

        public async Task<List<ColumnInfo>> GetColumnsAsync(string tableName)
        {
            // 实现获取列信息
            return await Task.FromResult(new List<ColumnInfo>());
        }
    }
}
```

### 7.3 Helper 示例

```csharp
// Helper/StringExtensions.cs
namespace SqlToER.Helper
{
    public static class StringExtensions
    {
        public static bool IsEmpty(this string? value)
        {
            return string.IsNullOrEmpty(value);
        }

        public static bool IsNotEmpty(this string? value)
        {
            return !string.IsNullOrEmpty(value);
        }
    }
}
```

---

## 8. 检查清单

提交代码前确认：

- [ ] 文件放在正确的目录
- [ ] 命名符合规范
- [ ] ViewModel 继承 `BindableBase`
- [ ] 属性使用 `SetProperty`
- [ ] 命令使用 `DelegateCommand`
- [ ] Service 定义了接口
- [ ] View 中无业务逻辑
- [ ] 可空类型正确标注
- [ ] 代码已格式化
